<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WorkoutTracker.ViewModels"
             xmlns:models="clr-namespace:WorkoutTracker.Models"
             xmlns:converters="clr-namespace:WorkoutTracker.Converters"
             x:Class="WorkoutTracker.Views.WorkoutPageView"
             x:DataType="vm:WorkoutViewModel"
             Title="Библиотека"
             BackgroundColor="{StaticResource BackgroundPrimary}">

    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />

        <DataTemplate x:Key="ExerciseItemTemplate" x:DataType="models:Exercise">
            <Border Style="{StaticResource CardStyle}" Margin="0,0,0,12" Padding="15">
                <Grid ColumnDefinitions="*, Auto">
                    <VerticalStackLayout Spacing="6">
                        <Label Text="{Binding Name}" Style="{StaticResource LabelBody}" FontAttributes="Bold"/>
                        <HorizontalStackLayout Spacing="8">
                            <Border BackgroundColor="{StaticResource BackgroundSecondary}" StrokeShape="RoundRectangle 6" Padding="6,2">
                                <Label Text="{Binding WorkTimeSeconds, StringFormat='Work: {0}s'}" FontSize="11" TextColor="{StaticResource AccentWork}" FontAttributes="Bold"/>
                            </Border>
                            <Border BackgroundColor="{StaticResource BackgroundSecondary}" StrokeShape="RoundRectangle 6" Padding="6,2">
                                <Label Text="{Binding RestTimeSeconds, StringFormat='Rest: {0}s'}" FontSize="11" TextColor="{StaticResource AccentRest}" FontAttributes="Bold"/>
                            </Border>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <Button Grid.Column="1" Text="✎" 
                            BackgroundColor="Transparent" TextColor="{StaticResource TextSecondary}"
                            WidthRequest="40" HeightRequest="40" FontSize="20"
                            Clicked="OnEditExerciseClicked" CommandParameter="{Binding Id}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="ProgramItemTemplate" x:DataType="models:Program">
            <Border Style="{StaticResource CardStyle}" Margin="0,0,0,12" Padding="0">
                <Grid>
                    <Grid.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                            <GradientStop Color="{StaticResource BackgroundCard}" Offset="0.0"/>
                            <GradientStop Color="{StaticResource BackgroundSecondary}" Offset="1.0"/>
                        </LinearGradientBrush>
                    </Grid.Background>

                    <Grid ColumnDefinitions="*, Auto, Auto" Padding="20">
                        <VerticalStackLayout VerticalOptions="Center" Spacing="4">
                            <Label Text="{Binding Name}" Style="{StaticResource LabelBody}" FontAttributes="Bold" FontSize="18"/>
                            <Label Text="{Binding Exercises.Count, StringFormat='Упражнений: {0}'}" Style="{StaticResource LabelCaption}"/>
                        </VerticalStackLayout>

                        <Button Grid.Column="1" Text="▶" 
                                Background="{StaticResource GradientMain}" TextColor="#0F1115"
                                WidthRequest="44" HeightRequest="44" CornerRadius="14" Padding="0" Margin="0,0,10,0"
                                Clicked="OnStartProgramClicked" CommandParameter="{Binding Id}"/>

                        <Button Grid.Column="2" Text="✎" 
                                BackgroundColor="{StaticResource BackgroundInput}" TextColor="{StaticResource TextPrimary}"
                                WidthRequest="44" HeightRequest="44" CornerRadius="14" Padding="0"
                                Clicked="OnEditProgramClicked" CommandParameter="{Binding Id}"/>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *">
        <Border Grid.Row="0" Margin="20,10" StrokeShape="RoundRectangle 16" BackgroundColor="{StaticResource BackgroundSecondary}" StrokeThickness="0" Padding="4">
            <Grid ColumnDefinitions="*, *">
                <Button Grid.Column="0" Text="Упражнения"
                        Command="{Binding SwitchToExercisesCommand}"
                        CornerRadius="12" HeightRequest="40" Padding="0" FontSize="13" FontAttributes="Bold">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding IsExercisesTabVisible}" Value="True">
                            <Setter Property="BackgroundColor" Value="{StaticResource BackgroundCard}"/>
                            <Setter Property="TextColor" Value="{StaticResource TextPrimary}"/>
                            <Setter Property="Shadow">
                                <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                            </Setter>
                        </DataTrigger>
                        <DataTrigger TargetType="Button" Binding="{Binding IsExercisesTabVisible}" Value="False">
                            <Setter Property="BackgroundColor" Value="Transparent"/>
                            <Setter Property="TextColor" Value="{StaticResource TextTertiary}"/>
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

                <Button Grid.Column="1" Text="Программы"
                        Command="{Binding SwitchToProgramsCommand}"
                        CornerRadius="12" HeightRequest="40" Padding="0" FontSize="13" FontAttributes="Bold">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding IsProgramsTabVisible}" Value="True">
                            <Setter Property="BackgroundColor" Value="{StaticResource BackgroundCard}"/>
                            <Setter Property="TextColor" Value="{StaticResource TextPrimary}"/>
                            <Setter Property="Shadow">
                                <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                            </Setter>
                        </DataTrigger>
                        <DataTrigger TargetType="Button" Binding="{Binding IsProgramsTabVisible}" Value="False">
                            <Setter Property="BackgroundColor" Value="Transparent"/>
                            <Setter Property="TextColor" Value="{StaticResource TextTertiary}"/>
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
            </Grid>
        </Border>

        <Grid Grid.Row="1" Padding="20,0">
            <CollectionView IsVisible="{Binding IsExercisesTabVisible}"
                            ItemsSource="{Binding Exercises}"
                            ItemTemplate="{StaticResource ExerciseItemTemplate}"
                            ItemsLayout="VerticalList" EmptyView="Нет упражнений"/>

            <CollectionView IsVisible="{Binding IsProgramsTabVisible}"
                            ItemsSource="{Binding Programs}"
                            ItemTemplate="{StaticResource ProgramItemTemplate}"
                            ItemsLayout="VerticalList" EmptyView="Нет программ"/>

            <Button Text="+" 
                    Background="{StaticResource GradientMain}"
                    TextColor="#0F1115"
                    WidthRequest="64" HeightRequest="64" CornerRadius="32" FontSize="32" Padding="0"
                    VerticalOptions="End" HorizontalOptions="End" Margin="0,0,10,20"
                    Command="{Binding CreateWorkoutCommand}">
                <Button.Shadow>
                    <Shadow Brush="{StaticResource AccentMain}" Offset="0,4" Radius="10" Opacity="0.4"/>
                </Button.Shadow>
            </Button>
        </Grid>
    </Grid>
</ContentPage>